<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ™ï¸ æ—¥è¯­å¯¹è¯æ’­å®¢ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dialogue-a { background: linear-gradient(90deg, #fef3c7, #fbbf24); }
        .dialogue-b { background: linear-gradient(90deg, #dbeafe, #3b82f6); }
        .audio-segment { transition: all 0.3s ease; }
        .audio-segment:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">
                ğŸ™ï¸ æ—¥è¯­å¯¹è¯æ’­å®¢ç”Ÿæˆå™¨
            </h1>
            <p class="text-gray-600">å°†ä»»ä½•å†…å®¹è½¬æ¢ä¸ºè‡ªç„¶çš„æ—¥è¯­åŒäººå¯¹è¯æ’­å®¢</p>
            <div class="mt-4 flex justify-center space-x-4 text-sm text-gray-500">
                <span class="flex items-center"><i class="fas fa-female text-pink-500 mr-1"></i> ä¸»æŒäººA (å¥³æ€§)</span>
                <span class="flex items-center"><i class="fas fa-male text-blue-500 mr-1"></i> ä¸»æŒäººB (ç”·æ€§)</span>
                <span class="flex items-center"><i class="fas fa-comments text-green-500 mr-1"></i> ä¸€é—®ä¸€ç­”å¯¹è¯</span>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-edit text-blue-500 mr-2"></i>
                    å†…å®¹è¾“å…¥
                </h2>
                
                <!-- é€‰é¡¹å¡ -->
                <div class="flex mb-4 bg-gray-100 rounded-lg p-1">
                    <button id="textTab" class="tab-button active flex-1 py-2 px-4 rounded-md transition-all duration-200 font-medium">
                        <i class="fas fa-keyboard mr-2"></i>æ–‡æœ¬è¾“å…¥
                    </button>
                    <button id="urlTab" class="tab-button flex-1 py-2 px-4 rounded-md transition-all duration-200 font-medium">
                        <i class="fas fa-globe mr-2"></i>URLè¾“å…¥
                    </button>
                </div>

                <!-- æ–‡æœ¬è¾“å…¥æ ‡ç­¾é¡µ -->
                <div id="textInput" class="tab-content">
                    <textarea id="content" rows="10" placeholder="è¾“å…¥ä½ æƒ³è½¬æ¢ä¸ºæ—¥è¯­å¯¹è¯æ’­å®¢çš„å†…å®¹..." 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯¹è¯é£æ ¼</label>
                        <select id="style" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="educational">æ•™è‚²æ€§ - é€‚åˆå­¦ä¹ å†…å®¹</option>
                            <option value="conversational">å¯¹è¯æ€§ - è½»æ¾èŠå¤©é£æ ¼</option>
                            <option value="interview">è®¿è°ˆå‹ - é—®ç­”äº’åŠ¨é£æ ¼</option>
                            <option value="narrative">å™è¿°å‹ - æ•…äº‹è®²è¿°é£æ ¼</option>
                        </select>
                    </div>
                </div>

                <!-- URLè¾“å…¥æ ‡ç­¾é¡µ -->
                <div id="urlInput" class="tab-content hidden">
                    <input type="url" id="url" placeholder="è¾“å…¥ç½‘é¡µURL..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
                    <button id="scrapeBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors duration-200">
                        <i class="fas fa-download mr-2"></i>æŠ“å–å†…å®¹
                    </button>
                    <div class="mt-2 text-xs text-gray-500">
                        æ”¯æŒåšå®¢ã€æ–°é—»ã€æ–‡ç« ç­‰ç½‘é¡µå†…å®¹æŠ“å–
                    </div>
                </div>

                <button id="generateBtn" class="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white py-3 px-6 rounded-lg font-semibold mt-6 transition-all duration-200 shadow-lg">
                                            <i class="fas fa-magic mr-2"></i>ç”Ÿæˆæ—¥è¯­æ’­å®¢
                </button>
                
                <!-- MiniMax API æµ‹è¯•æŒ‰é’® -->
                <button id="testMiniMaxBtn" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-2 px-4 rounded-lg font-medium mt-3 transition-all duration-200 shadow-md text-sm">
                    <i class="fas fa-flask mr-2"></i>æµ‹è¯• MiniMax API
                </button>
                
                <!-- çŠ¶æ€è¯´æ˜ -->
                <div class="mt-4 text-xs text-gray-500 text-center">
                    <i class="fas fa-shield-alt mr-1"></i>
                    APIå¯†é’¥å·²å®‰å…¨é…ç½®åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
                </div>
                
                <!-- MiniMax æµ‹è¯•ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="miniMaxTestResult" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-gray-700 mb-2">
                        <i class="fas fa-flask text-orange-500 mr-2"></i>MiniMax API æµ‹è¯•ç»“æœ
                    </h4>
                    <div id="miniMaxTestContent" class="text-sm text-gray-600"></div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-podcast text-purple-500 mr-2"></i>
                    æ’­å®¢ç»“æœ
                </h2>
                
                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loading" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mb-4"></div>
                    <p class="text-gray-600">æ­£åœ¨ç”Ÿæˆæ—¥è¯­æ’­å®¢...</p>
                    <p class="text-sm text-gray-500 mt-2">AIæ­£åœ¨åˆ›å»ºæ’­å®¢è„šæœ¬å¹¶ç”Ÿæˆæ—¥è¯­è¯­éŸ³</p>
                </div>

                <!-- é”™è¯¯æ˜¾ç¤º -->
                <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <p class="text-red-600 font-medium">ç”Ÿæˆå¤±è´¥</p>
                    <p id="errorMessage" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- æˆåŠŸç»“æœ -->
                <div id="result" class="hidden">
                    <!-- æ’­å®¢ä¿¡æ¯ -->
                    <div class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-purple-600" id="wordCount">0</div>
                                <div class="text-sm text-gray-600">æ€»å­—æ•°</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-blue-600" id="duration">0</div>
                                <div class="text-sm text-gray-600">é¢„ä¼°æ—¶é•¿(åˆ†é’Ÿ)</div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="text-lg font-semibold text-gray-700" id="segmentInfo">å¯¹è¯ç‰‡æ®µæ•°ï¼š0</div>
                        </div>
                    </div>

                    <!-- éŸ³é¢‘æ’­æ”¾å™¨åŒºåŸŸ -->
                    <div id="audioSection" class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-headphones text-green-500 mr-2"></i>
                            å¯¹è¯éŸ³é¢‘
                        </h3>
                        <div id="audioSegments" class="space-y-3">
                            <!-- éŸ³é¢‘ç‰‡æ®µå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å¯¹è¯è„šæœ¬æ˜¾ç¤º -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-scroll text-orange-500 mr-2"></i>
                            å¯¹è¯è„šæœ¬
                        </h3>
                        <div id="dialogueScript" class="space-y-2 max-h-96 overflow-y-auto border rounded-lg p-4">
                            <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>

                    <!-- å®Œæ•´è„šæœ¬ -->
                    <div>
                        <h3 class="text-lg font-semibold mb-3 flex items-center">
                            <i class="fas fa-file-text text-gray-500 mr-2"></i>
                            å®Œæ•´è„šæœ¬
                            <button id="copyScript" class="ml-2 text-sm bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                                <i class="fas fa-copy"></i> å¤åˆ¶
                            </button>
                        </h3>
                        <div id="fullScript" class="bg-gray-50 rounded-lg p-4 text-sm max-h-48 overflow-y-auto border font-mono"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const textTab = document.getElementById('textTab');
        const urlTab = document.getElementById('urlTab');
        const textInput = document.getElementById('textInput');
        const urlInput = document.getElementById('urlInput');
        const generateBtn = document.getElementById('generateBtn');
        const scrapeBtn = document.getElementById('scrapeBtn');
        const testMiniMaxBtn = document.getElementById('testMiniMaxBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const result = document.getElementById('result');
        
        // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨å½“å‰çš„éŸ³é¢‘ç‰‡æ®µçŠ¶æ€
        let currentAudioSegments = [];
        let statusCheckInterval = null;

        // æ ‡ç­¾é¡µåˆ‡æ¢
        textTab.addEventListener('click', () => switchTab('text'));
        urlTab.addEventListener('click', () => switchTab('url'));

        function switchTab(tab) {
            if (tab === 'text') {
                textTab.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                textTab.classList.remove('text-gray-600');
                urlTab.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                urlTab.classList.add('text-gray-600');
                textInput.classList.remove('hidden');
                urlInput.classList.add('hidden');
            } else {
                urlTab.classList.add('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                urlTab.classList.remove('text-gray-600');
                textTab.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow-sm');
                textTab.classList.add('text-gray-600');
                urlInput.classList.remove('hidden');
                textInput.classList.add('hidden');
            }
        }

        // æµ‹è¯•MiniMax API
        testMiniMaxBtn.addEventListener('click', async () => {
            const testResultDiv = document.getElementById('miniMaxTestResult');
            const testContentDiv = document.getElementById('miniMaxTestContent');
            
            testMiniMaxBtn.disabled = true;
            testMiniMaxBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
            
            testResultDiv.classList.remove('hidden');
            testContentDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin mr-2"></i>æ­£åœ¨æµ‹è¯•MiniMax API...</div>';
            
            try {
                const testData = {
                    text: 'ã“ã‚“ã«ã¡ã¯ã€çš†ã•ã‚“ã€‚ä»Šæ—¥ã¯ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã§ã™ã­ã€‚',
                    voice: 'female',
                    style: 'educational'
                };
                
                // ç›´æ¥è°ƒç”¨ç”ŸæˆAPIä½†ä½¿ç”¨ç‰¹æ®Šæ ‡è®°æ¥è§¦å‘æµ‹è¯•æ¨¡å¼
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: testData.text,
                        style: testData.style,
                        voice: testData.voice,
                        _test_mode: true
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    let resultHtml = '<div class="space-y-2">';
                    resultHtml += '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i><strong>æµ‹è¯•æˆåŠŸï¼</strong></div>';
                    resultHtml += `<div><strong>è„šæœ¬é•¿åº¦:</strong> ${data.script?.length || 0} å­—ç¬¦</div>`;
                    resultHtml += `<div><strong>é¢„ä¼°æ—¶é•¿:</strong> ${data.duration || 0} åˆ†é’Ÿ</div>`;
                    
                    // æ˜¾ç¤ºéŸ³é¢‘çŠ¶æ€
                    resultHtml += '<div class="mt-3"><strong>éŸ³é¢‘çŠ¶æ€:</strong></div>';
                    
                    if (data.audioUrl) {
                        resultHtml += '<div class="ml-4 text-green-600">';
                        resultHtml += 'â€¢ <i class="fas fa-check-circle mr-1"></i>éŸ³é¢‘ç”ŸæˆæˆåŠŸ';
                        resultHtml += ` <span class="text-xs text-blue-500">[éŸ³é¢‘URLå¯ç”¨]</span>`;
                        resultHtml += '</div>';
                        
                        // æ·»åŠ éŸ³é¢‘æ’­æ”¾å™¨
                        resultHtml += '<div class="mt-2 ml-4">';
                        resultHtml += `<audio controls class="w-full max-w-md">`;
                        resultHtml += `<source src="${data.audioUrl}" type="audio/mpeg">`;
                        resultHtml += 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚';
                        resultHtml += '</audio>';
                        resultHtml += '</div>';
                        
                    } else if (data.taskId) {
                        resultHtml += '<div class="ml-4 text-yellow-600">';
                        resultHtml += 'â€¢ <i class="fas fa-clock mr-1"></i>éŸ³é¢‘æ­£åœ¨ç”Ÿæˆä¸­';
                        resultHtml += ` <span class="text-xs text-gray-500">[ä»»åŠ¡ID: ${data.taskId.substring(0, 8)}...]</span>`;
                        resultHtml += '</div>';
                        
                    } else {
                        resultHtml += '<div class="ml-4 text-gray-600">';
                        resultHtml += 'â€¢ <i class="fas fa-info-circle mr-1"></i>éŸ³é¢‘æœªç”Ÿæˆ';
                        resultHtml += '</div>';
                    }
                    
                    // æ˜¾ç¤ºå…¶ä»–ä¿¡æ¯
                    if (data.metadata) {
                        resultHtml += '<div class="mt-3 text-sm text-gray-600">';
                        resultHtml += `<strong>æŠ€æœ¯ä¿¡æ¯:</strong><br>`;
                        resultHtml += `â€¢ è¯­éŸ³ID: ${data.metadata.voiceId || 'N/A'}<br>`;
                        resultHtml += `â€¢ è¯­è¨€: ${data.metadata.language || 'N/A'}<br>`;
                        resultHtml += `â€¢ æ˜¯å¦å¼‚æ­¥ä»»åŠ¡: ${data.metadata.isAsyncTask ? 'æ˜¯' : 'å¦'}`;
                        resultHtml += '</div>';
                    }
                    
                    resultHtml += '</div>';
                    testContentDiv.innerHTML = resultHtml;
                } else {
                    testContentDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-circle mr-2"></i><strong>æµ‹è¯•å¤±è´¥:</strong> ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
                
            } catch (err) {
                testContentDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i><strong>æµ‹è¯•å¼‚å¸¸:</strong> ${err.message}</div>`;
            } finally {
                testMiniMaxBtn.disabled = false;
                testMiniMaxBtn.innerHTML = '<i class="fas fa-flask mr-2"></i>æµ‹è¯• MiniMax API';
            }
        });

        // æŠ“å–ç½‘é¡µå†…å®¹
        scrapeBtn.addEventListener('click', async () => {
            const url = document.getElementById('url').value.trim();
            if (!url) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URL');
                return;
            }

            scrapeBtn.disabled = true;
            scrapeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æŠ“å–ä¸­...';

            try {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('content').value = data.content;
                    switchTab('text');
                    alert('ç½‘é¡µå†…å®¹æŠ“å–æˆåŠŸï¼');
                } else {
                    alert('æŠ“å–å¤±è´¥: ' + data.error);
                }
            } catch (err) {
                alert('æŠ“å–å¤±è´¥: ' + err.message);
            } finally {
                scrapeBtn.disabled = false;
                scrapeBtn.innerHTML = '<i class="fas fa-download mr-2"></i>æŠ“å–å†…å®¹';
            }
        });

        // ç”Ÿæˆæ’­å®¢
        generateBtn.addEventListener('click', async () => {
            const content = document.getElementById('content').value.trim();
            const style = document.getElementById('style').value;

            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            if (content.length < 100) {
                alert('å†…å®¹å¤ªçŸ­ï¼Œè¯·è¾“å…¥è‡³å°‘100å­—ç¬¦çš„å†…å®¹');
                return;
            }

            // éšè—ä¹‹å‰çš„ç»“æœ
            hideAllSections();
            loading.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content,
                        style,
                        voice: 'female'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayPodcastResult(data);
                } else {
                    showError(data.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (err) {
                showError('è¯·æ±‚å¤±è´¥: ' + err.message);
            } finally {
                loading.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i>ç”Ÿæˆæ—¥è¯­æ’­å®¢';
            }
        });

        // æ˜¾ç¤ºæ’­å®¢ç»“æœ
        function displayPodcastResult(data) {
            document.getElementById('wordCount').textContent = data.wordCount || 0;
            document.getElementById('duration').textContent = data.duration || 0;
            document.getElementById('segmentInfo').textContent = 
                'è„šæœ¬é•¿åº¦ï¼š' + (data.script?.length || 0) + ' å­—ç¬¦ | éŸ³é¢‘çŠ¶æ€ï¼š' + (data.audioUrl ? 'å·²ç”Ÿæˆ' : data.taskId ? 'ç”Ÿæˆä¸­' : 'æœªç”Ÿæˆ');

            // æ˜¾ç¤ºå•ä¸ªéŸ³é¢‘æ’­æ”¾å™¨
            displaySingleAudio(data);
            
            // éšè—å¯¹è¯ç›¸å…³çš„æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('dialogueScript').innerHTML = '<p class="text-gray-500 text-center py-4">å•äººæ’­å®¢æ¨¡å¼</p>';
            
            document.getElementById('fullScript').textContent = data.script || '';
            result.classList.remove('hidden');
            
            // å¦‚æœæœ‰å¼‚æ­¥ä»»åŠ¡ï¼Œå¯åŠ¨çŠ¶æ€æ£€æŸ¥
            if (data.taskId) {
                startSingleAudioStatusPolling(data.taskId);
            }
        }

        // æ˜¾ç¤ºå•ä¸ªéŸ³é¢‘æ’­æ”¾å™¨
        function displaySingleAudio(data) {
            const container = document.getElementById('audioSegments');
            container.innerHTML = '';

            if (data.audioUrl) {
                const audioHtml = '<div class="bg-green-50 rounded-lg p-4 shadow-sm">' +
                    '<div class="flex items-center justify-between mb-2">' +
                    '<span class="font-semibold text-gray-700 flex items-center">' +
                    '<i class="fas fa-microphone text-green-500 mr-2"></i>' +
                    'æ—¥è¯­æ’­å®¢éŸ³é¢‘' +
                    '</span>' +
                    '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">å·²å®Œæˆ</span>' +
                    '</div>' +
                    '<audio controls class="w-full">' +
                    '<source src="' + data.audioUrl + '" type="audio/mpeg">' +
                    'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚' +
                    '</audio>' +
                    '</div>';
                container.innerHTML = audioHtml;
            } else if (data.taskId) {
                const loadingHtml = '<div class="bg-yellow-50 rounded-lg p-4 shadow-sm">' +
                    '<div class="flex items-center justify-between mb-2">' +
                    '<span class="font-semibold text-gray-700 flex items-center">' +
                    '<i class="fas fa-clock text-yellow-500 mr-2"></i>' +
                    'æ—¥è¯­æ’­å®¢éŸ³é¢‘' +
                    '</span>' +
                    '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">ç”Ÿæˆä¸­</span>' +
                    '</div>' +
                    '<div class="bg-yellow-100 border border-yellow-200 rounded-lg p-3 text-center">' +
                    '<i class="fas fa-spinner fa-spin text-yellow-500 mr-2"></i>' +
                    '<span class="text-yellow-700">éŸ³é¢‘æ­£åœ¨ç”Ÿæˆä¸­ï¼Œä»»åŠ¡ID: ' + data.taskId.substring(0, 8) + '...</span>' +
                    '</div>' +
                    '</div>';
                container.innerHTML = loadingHtml;
            } else {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-volume-mute text-4xl mb-2"></i><p>æš‚æ— éŸ³é¢‘</p><p class="text-sm">éŸ³é¢‘ç”Ÿæˆå¯èƒ½å¤±è´¥æˆ–æœªå¯ç”¨</p></div>';
            }
        }

        // å•ä¸ªéŸ³é¢‘ä»»åŠ¡çŠ¶æ€è½®è¯¢
        function startSingleAudioStatusPolling(taskId) {
            if (!taskId) return;
            
            console.log('å¼€å§‹è½®è¯¢å•ä¸ªéŸ³é¢‘ä»»åŠ¡:', taskId);
            
            // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            // å¼€å§‹æ–°çš„è½®è¯¢ï¼Œæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
            statusCheckInterval = setInterval(() => checkSingleAudioStatus(taskId), 10000);
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            checkSingleAudioStatus(taskId);
        }

        async function checkSingleAudioStatus(taskId) {
            try {
                const response = await fetch('/api/check-audio-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskIds: [taskId]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.results && data.results.length > 0) {
                        const result = data.results[0];
                        
                        if (result.status === 'Success' && result.audioUrl) {
                            // ä»»åŠ¡å®Œæˆï¼Œæ›´æ–°æ˜¾ç¤º
                            console.log('éŸ³é¢‘ç”Ÿæˆå®Œæˆ:', result.audioUrl);
                            displaySingleAudio({ audioUrl: result.audioUrl });
                            
                            // åœæ­¢è½®è¯¢
                            if (statusCheckInterval) {
                                clearInterval(statusCheckInterval);
                                statusCheckInterval = null;
                            }
                            
                            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                            document.getElementById('segmentInfo').textContent = 
                                'è„šæœ¬é•¿åº¦ï¼š' + (document.getElementById('fullScript').textContent.length || 0) + ' å­—ç¬¦ | éŸ³é¢‘çŠ¶æ€ï¼šå·²ç”Ÿæˆ';
                                
                        } else if (result.status === 'Failed') {
                            console.log('éŸ³é¢‘ç”Ÿæˆå¤±è´¥:', result.errorMessage);
                            displaySingleAudio({ error: result.errorMessage });
                            
                            // åœæ­¢è½®è¯¢
                            if (statusCheckInterval) {
                                clearInterval(statusCheckInterval);
                                statusCheckInterval = null;
                            }
                        }
                        // ProcessingçŠ¶æ€ç»§ç»­è½®è¯¢
                    }
                }
            } catch (error) {
                console.error('çŠ¶æ€æ£€æŸ¥å¼‚å¸¸:', error);
            }
        }

        // æ˜¾ç¤ºéŸ³é¢‘ç‰‡æ®µ
        function displayAudioSegments(audioSegments) {
            const container = document.getElementById('audioSegments');
            container.innerHTML = '';

            if (!audioSegments || audioSegments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-volume-mute text-4xl mb-2"></i><p>æš‚æ— éŸ³é¢‘ç‰‡æ®µ</p><p class="text-sm">éŸ³é¢‘ç”Ÿæˆå¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´ï¼Œæˆ–æ­£åœ¨åå°å¤„ç†ä¸­</p></div>';
                return;
            }

            audioSegments.forEach((segment, index) => {
                // éªŒè¯segmentå¯¹è±¡
                if (!segment) {
                    console.warn('è·³è¿‡null segmentï¼Œindex:', index);
                    return;
                }

                if (!segment.speaker) {
                    console.warn('è·³è¿‡ç¼ºå°‘speakerçš„segment:', segment);
                    return;
                }

                const speakerInfo = segment.speaker === 'ä¸»æŒäººA' ? 
                    { name: 'ä¸»æŒäººA', icon: 'fa-female', color: 'pink', bgColor: 'dialogue-a' } :
                    segment.speaker === 'ä¸»æŒäººB' ?
                    { name: 'ä¸»æŒäººB', icon: 'fa-male', color: 'blue', bgColor: 'dialogue-b' } :
                    { name: segment.speaker || 'Unknown', icon: 'fa-user', color: 'gray', bgColor: 'bg-gray-100' };

                let statusBadge = '';
                let audioPlayer = '';
                
                if (segment.status === 'completed' && segment.audioUrl) {
                    statusBadge = '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">å·²å®Œæˆ</span>';
                    audioPlayer = '<audio controls class="w-full">' +
                        '<source src="' + segment.audioUrl + '" type="audio/mpeg">' +
                        'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚' +
                        '</audio>';
                } else if (segment.status === 'pending' && segment.taskId) {
                    statusBadge = '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">å¤„ç†ä¸­</span>';
                    audioPlayer = '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">' +
                        '<i class="fas fa-clock text-yellow-500 mr-2"></i>' +
                        '<span class="text-yellow-700">éŸ³é¢‘æ­£åœ¨ç”Ÿæˆä¸­ï¼Œä»»åŠ¡ID: ' + segment.taskId + '</span>' +
                        '</div>';
                } else if (segment.status === 'failed') {
                    statusBadge = '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">å¤±è´¥</span>';
                    audioPlayer = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center text-red-600">' +
                        '<i class="fas fa-exclamation-triangle mr-2"></i>éŸ³é¢‘ç”Ÿæˆå¤±è´¥' +
                        '</div>';
                } else {
                    statusBadge = '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded-full">æœªçŸ¥çŠ¶æ€</span>';
                    audioPlayer = '<div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center text-gray-600">' +
                        '<i class="fas fa-question-circle mr-2"></i>éŸ³é¢‘çŠ¶æ€æœªçŸ¥' +
                        '</div>';
                }

                const segmentHtml = '<div class="audio-segment ' + speakerInfo.bgColor + ' rounded-lg p-4 shadow-sm">' +
                    '<div class="flex items-center justify-between mb-2">' +
                    '<span class="font-semibold text-gray-700 flex items-center">' +
                    '<i class="fas ' + speakerInfo.icon + ' text-' + speakerInfo.color + '-500 mr-2"></i>' +
                    speakerInfo.name + ' - ç‰‡æ®µ ' + (index + 1) +
                    '</span>' +
                    statusBadge +
                    '</div>' +
                    '<p class="text-sm text-gray-600 mb-3">' + segment.text.substring(0, 100) + (segment.text.length > 100 ? '...' : '') + '</p>' +
                    audioPlayer +
                    '</div>';
                container.insertAdjacentHTML('beforeend', segmentHtml);
            });
        }

        // æ˜¾ç¤ºå¯¹è¯è„šæœ¬
        function displayDialogueScript(dialogues) {
            const container = document.getElementById('dialogueScript');
            container.innerHTML = '';

            if (!dialogues || dialogues.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">æš‚æ— å¯¹è¯å†…å®¹</p>';
                return;
            }

            dialogues.forEach((dialogue, index) => {
                // éªŒè¯dialogueå¯¹è±¡
                if (!dialogue) {
                    console.warn('è·³è¿‡null dialogueï¼Œindex:', index);
                    return;
                }

                if (!dialogue.speaker) {
                    console.warn('è·³è¿‡ç¼ºå°‘speakerçš„dialogue:', dialogue);
                    return;
                }

                const speakerInfo = dialogue.speaker === 'ä¸»æŒäººA' ? 
                    { name: 'ä¸»æŒäººA', icon: 'fa-female', color: 'pink-500', bgClass: 'dialogue-a' } :
                    dialogue.speaker === 'ä¸»æŒäººB' ?
                    { name: 'ä¸»æŒäººB', icon: 'fa-male', color: 'blue-500', bgClass: 'dialogue-b' } :
                    { name: dialogue.speaker || 'Unknown', icon: 'fa-user', color: 'gray-500', bgClass: 'bg-gray-100' };

                const partHtml = '<div class="' + speakerInfo.bgClass + ' rounded-lg p-3 border-l-4 border-' + speakerInfo.color + ' mb-2">' +
                    '<div class="font-semibold text-gray-700 mb-1 flex items-center">' +
                    '<i class="fas ' + speakerInfo.icon + ' text-' + speakerInfo.color + ' mr-2"></i>' +
                    speakerInfo.name + ' <span class="ml-2 text-xs text-gray-500">(ç¬¬' + (index + 1) + 'æ®µ)</span>' +
                    '</div>' +
                    '<p class="text-gray-700">' + dialogue.text + '</p>' +
                    '</div>';
                container.insertAdjacentHTML('beforeend', partHtml);
            });
        }

        // éŸ³é¢‘çŠ¶æ€è½®è¯¢ç›¸å…³å‡½æ•°
        function startAudioStatusPolling() {
            const pendingTasks = currentAudioSegments.filter(segment => 
                segment.status === 'pending' && segment.taskId
            );
            
            if (pendingTasks.length === 0) {
                return; // æ²¡æœ‰pendingçš„ä»»åŠ¡ï¼Œä¸éœ€è¦è½®è¯¢
            }
            
            console.log('å¼€å§‹è½®è¯¢', pendingTasks.length, 'ä¸ªpendingéŸ³é¢‘ä»»åŠ¡');
            
            // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            // å¼€å§‹æ–°çš„è½®è¯¢ï¼Œæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
            statusCheckInterval = setInterval(checkAudioStatus, 10000);
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            checkAudioStatus();
        }

        async function checkAudioStatus() {
            const pendingTasks = currentAudioSegments.filter(segment => 
                segment.status === 'pending' && segment.taskId
            );
            
            if (pendingTasks.length === 0) {
                // æ²¡æœ‰pendingçš„ä»»åŠ¡äº†ï¼Œåœæ­¢è½®è¯¢
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
                return;
            }
            
            const taskIds = pendingTasks.map(task => task.taskId);
            
            try {
                const response = await fetch('/api/check-audio-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskIds: taskIds
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        updateAudioSegmentStatus(data.results);
                        
                        // å¦‚æœè¿˜æœ‰processingçš„ä»»åŠ¡ï¼Œç»§ç»­è½®è¯¢
                        const stillProcessing = data.results.filter(r => r.status === 'Processing').length;
                        console.log('çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œä»åœ¨å¤„ç†ä¸­:', stillProcessing, 'ä¸ªä»»åŠ¡');
                        
                        if (stillProcessing === 0) {
                            // æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼Œåœæ­¢è½®è¯¢
                            if (statusCheckInterval) {
                                clearInterval(statusCheckInterval);
                                statusCheckInterval = null;
                            }
                        }
                    }
                } else {
                    console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', await response.text());
                }
            } catch (error) {
                console.error('çŠ¶æ€æ£€æŸ¥å¼‚å¸¸:', error);
            }
        }

        function updateAudioSegmentStatus(statusResults) {
            let hasUpdates = false;
            
            if (!statusResults || !Array.isArray(statusResults)) {
                console.warn('Invalid statusResults:', statusResults);
                return;
            }
            
            statusResults.forEach(result => {
                if (!result || !result.taskId) {
                    console.warn('è·³è¿‡invalid result:', result);
                    return;
                }

                const segmentIndex = currentAudioSegments.findIndex(segment => 
                    segment && segment.taskId === result.taskId
                );
                
                if (segmentIndex !== -1 && currentAudioSegments[segmentIndex]) {
                    const oldStatus = currentAudioSegments[segmentIndex].status;
                    
                    if (result.status === 'Success' && result.audioUrl) {
                        currentAudioSegments[segmentIndex].status = 'completed';
                        currentAudioSegments[segmentIndex].audioUrl = result.audioUrl;
                        hasUpdates = true;
                    } else if (result.status === 'Failed' || result.status === 'error') {
                        currentAudioSegments[segmentIndex].status = 'failed';
                        currentAudioSegments[segmentIndex].errorMessage = result.errorMessage;
                        hasUpdates = true;
                    }
                    // ProcessingçŠ¶æ€ä¿æŒä¸å˜
                    
                    if (oldStatus !== currentAudioSegments[segmentIndex].status) {
                        console.log(`ä»»åŠ¡ ${result.taskId} çŠ¶æ€ä» ${oldStatus} æ›´æ–°ä¸º ${currentAudioSegments[segmentIndex].status}`);
                    }
                }
            });
            
            if (hasUpdates) {
                // é‡æ–°æ¸²æŸ“éŸ³é¢‘ç‰‡æ®µ
                displayAudioSegments(currentAudioSegments);
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const completedCount = currentAudioSegments.filter(s => s.status === 'completed').length;
                document.getElementById('segmentInfo').textContent = 
                    'å¯¹è¯ç‰‡æ®µæ•°ï¼š' + currentAudioSegments.length + ' | å·²ç”ŸæˆéŸ³é¢‘ï¼š' + completedCount;
            }
        }

        // å¤åˆ¶è„šæœ¬åŠŸèƒ½
        document.getElementById('copyScript').addEventListener('click', () => {
            const script = document.getElementById('fullScript').textContent;
            navigator.clipboard.writeText(script).then(() => {
                const btn = document.getElementById('copyScript');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        });

        // è¾…åŠ©å‡½æ•°
        function hideAllSections() {
            loading.classList.add('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
        }

        function showError(message) {
            error.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        });

        // é¡µé¢éšè—æ—¶æš‚åœè½®è¯¢ï¼Œæ˜¾ç¤ºæ—¶æ¢å¤
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—ï¼Œæš‚åœè½®è¯¢
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            } else {
                // é¡µé¢æ˜¾ç¤ºï¼Œå¦‚æœæœ‰pendingä»»åŠ¡åˆ™æ¢å¤è½®è¯¢
                if (currentAudioSegments.some(s => s.status === 'pending')) {
                    startAudioStatusPolling();
                }
            }
        });

        // æ ·å¼
        const style = document.createElement('style');
        style.textContent = '.tab-button.active { background: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); } .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }';
        document.head.appendChild(style);
    </script>
</body>
</html>
