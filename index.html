<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆç”Ÿæˆå™¨ - ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§æ—¥æœ¬èªãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .audio-player {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .speaker-akira {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left: 4px solid #ff6b6b;
        }
        .speaker-yuuki {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-left: 4px solid #4ecdc4;
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white py-8 px-4 sm:px-0">
            <div class="container mx-auto px-4 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2 flex flex-col sm:flex-row items-center justify-center text-center">
                    <i class="fas fa-microphone-alt mr-3"></i>
                    AIãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆç”Ÿæˆå™¨
                </h1>
                <p class="text-lg sm:text-xl opacity-90 leading-snug sm:leading-normal mx-auto max-w-md sm:max-w-none">ã‚¦ã‚§ãƒ–ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ã€ã‚¢ã‚­ãƒ© & ãƒ¦ã‚¦ã‚­ã®æ—¥æœ¬èªãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ç”Ÿæˆ</p>
                <div class="mt-4 flex justify-center flex-wrap gap-3 sm:gap-6 text-xs sm:text-sm">
                    <span><i class="fas fa-robot mr-2"></i>AIå¯¾è©±</span>
                    <span><i class="fas fa-users mr-2"></i>äºŒäººãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£</span>
                    <span><i class="fas fa-language mr-2"></i>æ—¥æœ¬èªãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</span>
                    <span><i class="fas fa-bolt mr-2"></i>ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ç”Ÿæˆ</span>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- ä¸»è¦åŠŸèƒ½åŒº -->
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-2">ğŸ™ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ç”Ÿæˆ</h2>
                    <p class="text-gray-600">ãƒ–ãƒ­ã‚°è¨˜äº‹ã‹ã‚‰äºŒäººã®æ—¥æœ¬èªãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¾ã§ã€ãƒªãƒ³ã‚¯ã²ã¨ã¤ã§</p>
                </div>

                <!-- URLè¾“å…¥åŒº -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-link mr-2"></i>ã‚¦ã‚§ãƒ–ãƒªãƒ³ã‚¯
                    </label>
                    <input 
                        type="url" 
                        id="urlInput" 
                        placeholder="ãƒ–ãƒ­ã‚°ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚„è¨˜äº‹ã®URLã‚’å…¥åŠ›..." 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                    >
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        ãƒ–ãƒ­ã‚°ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€Wikipediaã€Medium ãªã©ã®ãƒšãƒ¼ã‚¸ã«å¯¾å¿œï¼ˆXãƒ»Twitterã®ãƒã‚¹ãƒˆã¯éå¯¾å¿œï¼‰
                    </div>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <button 
                    id="generateBtn" 
                    class="w-full bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white py-4 px-6 rounded-lg font-semibold text-lg transition-all duration-300 shadow-lg hover:shadow-xl"
                >
                    <i class="fas fa-magic mr-3"></i>
                    äºŒäººãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ç”Ÿæˆ
                </button>

                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                <div id="progressSection" class="hidden mt-6">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">é€²æ—</span>
                            <span id="progressText" class="text-sm text-gray-500">æº–å‚™ä¸­...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="hidden bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="pulse-animation inline-block w-16 h-16 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full mb-4 flex items-center justify-center">
                    <i class="fas fa-microphone text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold mb-2">ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ç”Ÿæˆä¸­...</h3>
                <p id="loadingMessage" class="text-gray-600">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚AIãŒä½œæ¥­ã—ã¦ã„ã¾ã™</p>
            </div>

            <!-- é”™è¯¯æ˜¾ç¤º -->
            <div id="error" class="hidden bg-white rounded-xl shadow-lg p-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                        <div>
                            <h3 class="text-red-800 font-medium">ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                            <p id="errorMessage" class="text-red-600 text-sm mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ’­å®¢ç»“æœæ˜¾ç¤º -->
            <div id="result" class="hidden">
                <!-- æ’­å®¢ä¿¡æ¯å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">
                            <i class="fas fa-podcast text-purple-500 mr-2"></i>
                            ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãŒå®Œæˆã—ã¾ã—ãŸ
                        </h2>
                        <p class="text-gray-600">ã‚¢ã‚­ãƒ©ã¨ãƒ¦ã‚¦ã‚­ã®äºŒäººå¯¾è©±ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ</p>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="text-center p-3 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="segmentCount">0</div>
                            <div class="text-sm text-gray-600">ä¼šè©±ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</div>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="totalDuration">0</div>
                            <div class="text-sm text-gray-600">ç·æ™‚é–“(ç§’)</div>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="wordCount">0</div>
                            <div class="text-sm text-gray-600">ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ–‡å­—æ•°</div>
                        </div>
                    </div>

                    <!-- éŸ³é¢‘æ’­æ”¾å™¨åŒºåŸŸ -->
                    <div id="audioSection">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-headphones text-green-500 mr-2"></i>
                            ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆéŸ³å£°
                        </h3>
                        <div id="audioList" class="space-y-3">
                            <!-- éŸ³é¢‘ç‰‡æ®µå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å¯¹è¯è„šæœ¬æ˜¾ç¤º -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-scroll text-orange-500 mr-2"></i>
                        ä¼šè©±ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
                        <button id="copyScript" class="ml-auto text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded transition-colors">
                            <i class="fas fa-copy mr-1"></i>ã‚³ãƒ”ãƒ¼
                        </button>
                    </h3>
                    <div id="scriptDisplay" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- å¯¹è¯å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const urlInput = document.getElementById('urlInput');
        const generateBtn = document.getElementById('generateBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const loading = document.getElementById('loading');
        const loadingMessage = document.getElementById('loadingMessage');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const result = document.getElementById('result');

        // ç”Ÿæˆæ’­å®¢ä¸»å‡½æ•°
        generateBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!isValidUrl(url)) {
                alert('æœ‰åŠ¹ãªã‚¦ã‚§ãƒ–ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // å¼€å§‹ç”Ÿæˆæµç¨‹
            startGeneration(url);
        });

        // éªŒè¯URLæ ¼å¼
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // å¼€å§‹ç”Ÿæˆæµç¨‹
        async function startGeneration(url) {
            // éšè—ä¹‹å‰çš„ç»“æœ
            hideAllSections();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';

            try {
                // è°ƒç”¨ä¸€ä½“åŒ–API
                progressSection.classList.remove('hidden');
                setProgress(5, 'ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’å–å¾—ä¸­');

                // åŠ¨æ€é€’å¢åˆ°55%
                let dynamicPercent = 5;
                const progressTimer = setInterval(()=>{
                    if(dynamicPercent < 55){
                        dynamicPercent += 1;
                        setProgress(dynamicPercent, 'AIå‡¦ç†ä¸­');
                    }
                }, 1000);
                const response = await fetch('/api/generate-podcast-from-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url })
                });

                clearInterval(progressTimer);
                setProgress(60, 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»éŸ³å£°ç”Ÿæˆä¸­');
                const data = await response.json();

                if (data.success) {
                    setProgress(90, 'éŸ³å£°çµ±åˆä¸­');
                    displayPodcastResult(data);
                    setProgress(100, 'å®Œäº†');
                } else {
                    showError(data.error || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„');
                }

            } catch (err) {
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message);
            } finally {
                loading.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic mr-3"></i>äºŒäººãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’ç”Ÿæˆ';
            }
        }

        // æ›´æ–°åŠ è½½ä¿¡æ¯
        function updateLoadingMessage(message) {
            loadingMessage.textContent = message;
        }

        // æ˜¾ç¤ºæ’­å®¢ç»“æœ
        function displayPodcastResult(data) {
            console.log('æ’­å®¢æ•°æ®:', data);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('segmentCount').textContent = data.audioSegments?.length || 0;
            document.getElementById('totalDuration').textContent = data.totalDuration || 0;
            document.getElementById('wordCount').textContent = data.wordCount || 0;

            // æ˜¾ç¤ºéŸ³é¢‘ç‰‡æ®µ
            const audioListEl = document.getElementById('audioList');
            audioListEl.innerHTML = '';

            if (data.finalAudioUrl) {
                // å°† base64 DataURL è½¬ä¸º Blobï¼Œé¿å… fetch é•¿ URL å¤±è´¥
                const base64 = data.finalAudioUrl.split(',')[1];
                const byteChars = atob(base64);
                const byteNums = new Uint8Array(byteChars.length);
                for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
                const blob = new Blob([byteNums], { type: 'audio/mpeg' });
                const blobUrl = URL.createObjectURL(blob);

                audioListEl.innerHTML = `
                  <div class="audio-player rounded-lg p-4 text-white text-center">
                      <p class="mb-3 font-semibold">ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå…¨ç·¨éŸ³å£°</p>
                      <audio controls class="w-full mb-4">
                          <source src="${blobUrl}" type="audio/mpeg">
                          ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“
                      </audio>
                      <button id="downloadBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm">
                          <i class="fas fa-download mr-1"></i>MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      </button>
                  </div>`;

                // ç»‘å®šä¸‹è½½æŒ‰é’®
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = 'podcast.mp3';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
            } else {
                audioListEl.innerHTML =
                  '<div class="text-center py-8 text-gray-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
            }

            // æ˜¾ç¤ºå¯¹è¯è„šæœ¬
            if (data.dialogueSegments && data.dialogueSegments.length > 0) {
                displayScript(data.dialogueSegments);
            }

            // æ˜¾ç¤ºç»“æœ
            result.classList.remove('hidden');
        }

        // æ˜¾ç¤ºéŸ³é¢‘ç‰‡æ®µ
        function displayAudioSegments(audioSegments) {
            const container = document.getElementById('audioList');
            container.innerHTML = '';

            audioSegments.forEach((segment, index) => {
                const isAkira = segment.speaker === 'ã‚¢ã‚­ãƒ©';
                const speakerClass = isAkira ? 'speaker-akira' : 'speaker-yuuki';
                const iconClass = isAkira ? 'fa-female' : 'fa-male';
                
                const segmentHtml = `
                <div class="${speakerClass} rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold flex items-center">
                            <i class="fas ${iconClass} mr-2"></i>
                            ${segment.speaker} - ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ${index + 1}
                        </span>
                        <span class="text-xs bg-white bg-opacity-50 px-2 py-1 rounded">${segment.duration || 0}ç§’</span>
                    </div>
                    <p class="text-sm text-gray-700 mb-3">${segment.text}</p>
                    ${segment.audioUrl ? 
                        `<audio controls class="w-full">
                            <source src="${segment.audioUrl}" type="audio/mpeg">
                            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“
                         </audio>` : 
                        '<div class="bg-red-100 text-red-600 p-2 rounded text-sm">éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                    }
                </div>`;
                
                container.insertAdjacentHTML('beforeend', segmentHtml);
            });
        }

        // æ˜¾ç¤ºå¯¹è¯è„šæœ¬
        function displayScript(dialogueSegments) {
            const container = document.getElementById('scriptDisplay');
            container.innerHTML = '';

            dialogueSegments.forEach((segment, index) => {
                const isAkira = segment.speaker === 'akira';
                const speakerClass = isAkira ? 'speaker-akira' : 'speaker-yuuki';
                const iconClass = isAkira ? 'fa-female' : 'fa-male';
                const speakerName = isAkira ? 'ã‚¢ã‚­ãƒ©' : 'ãƒ¦ã‚¦ã‚­';
                
                const segmentHtml = `
                <div class="${speakerClass} rounded-lg p-3">
                    <div class="font-semibold text-gray-700 mb-1 flex items-center">
                        <i class="fas ${iconClass} mr-2"></i>
                        ${speakerName}
                    </div>
                    <p class="text-gray-700">${segment.text}</p>
                </div>`;
                
                container.insertAdjacentHTML('beforeend', segmentHtml);
            });
        }

        // å¤åˆ¶è„šæœ¬åŠŸèƒ½
        document.getElementById('copyScript').addEventListener('click', () => {
            const scriptElement = document.getElementById('scriptDisplay');
            const scriptText = Array.from(scriptElement.children)
                .map(child => child.textContent)
                .join('\n\n');
            
            navigator.clipboard.writeText(scriptText).then(() => {
                const btn = document.getElementById('copyScript');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-1"></i>ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        });

        // è¾…åŠ©å‡½æ•°
        function hideAllSections() {
            loading.classList.add('hidden');
            error.classList.add('hidden');
            result.classList.add('hidden');
            progressSection.classList.add('hidden');
        }

        function showError(message) {
            error.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        function setProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressText.textContent = text + ' ' + percent + '%';
        }
    </script>
</body>
</html>
